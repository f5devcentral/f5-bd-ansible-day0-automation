---

- name: Debug sequence number
  debug:
    msg: "Current sequence number is {{ sequence_number }}"

- name: Read file and modify with ansible variables
  set_fact:
    metadata: "{{ lookup('template','metadata.yml', split_lines=False)  | from_yaml}}"
    userdata: "{{ lookup('template','userdata.yml', split_lines=False) | from_yaml}}"

- debug:
    var: metadata

- debug:
    var: userdata

- name: re-encode metadata and userdata into base64
  set_fact:
    base64_metadata: "{{ metadata | to_nice_yaml | b64encode  }}"
    base64_userdata: "I2Nsb3VkLWNvbmZpZyAK{{ userdata | to_nice_yaml | b64encode }}"

- debug:
    var: base64_metadata

- debug:
    var: base64_userdata

- name: Modify VM Advanced Parameters for Cloud-init
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ vm_hostname }}{{ ova_builds_var.tmpl_name }}-00{{ sequence_number }}"
    advanced_settings:
    - "key": "guestinfo.metadata"
      "value": "{{base64_metadata}}"
    - "key": "guestinfo.metadata.encoding"
      "value": "base64"
    - "key": "guestinfo.userdata"
      "value": "{{base64_userdata}}"
    - "key": "guestinfo.userdata.encoding"
      "value": "base64"
  delegate_to: localhost
